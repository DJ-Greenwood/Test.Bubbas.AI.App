{% extends 'base.html' %}

{% block title %}Chat with Bubbas - Bubbas.ai{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        display: flex;
        height: calc(100vh - 150px);
    }
    
    .sidebar {
        width: 250px;
        border-right: 1px solid #e5e5e5;
        overflow-y: auto;
        padding: 15px;
    }
    
    .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
    }
    
    .chat-input {
        border-top: 1px solid #e5e5e5;
        padding: 15px;
    }
    
    .message {
        margin-bottom: 15px;
        max-width: 80%;
    }
    
    .message.user {
        margin-left: auto;
        background-color: #e2f0ff;
        border-radius: 15px 15px 0 15px;
        padding: 10px 15px;
    }
    
    .message.assistant {
        margin-right: auto;
        background-color: #f0f0f0;
        border-radius: 15px 15px 15px 0;
        padding: 10px 15px;
    }
    
    .message-input {
        width: 100%;
        padding: 10px;
        border: 1px solid #e5e5e5;
        border-radius: 5px;
        resize: none;
    }
    
    .conversation-list {
        list-style: none;
        padding: 0;
        margin: 15px 0;
    }
    
    .conversation-item {
        padding: 8px 10px;
        border-radius: 5px;
        margin-bottom: 5px;
        cursor: pointer;
    }
    
    .conversation-item:hover {
        background-color: #f5f5f5;
    }
    
    .conversation-item.active {
        background-color: #e2f0ff;
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="sidebar">
        <div class="sidebar-header">
            <h3>Conversations</h3>
            <button id="new-conversation-btn" class="btn btn-sm btn-primary">New Chat</button>
        </div>
        
        <ul class="conversation-list">
            {% for conv in conversations %}
            <li class="conversation-item {% if conv.id == current_conversation.id %}active{% endif %}" data-id="{{ conv.id }}">
                {{ conv.title|default:"New Conversation" }}
            </li>
            {% endfor %}
        </ul>
    </div>
    
    <div class="chat-main">
        <div class="chat-messages" id="chat-messages">
            {% for message in messages %}
            <div class="message {{ message.role }}">
                {{ message.content|linebreaksbr }}
            </div>
            {% empty %}
            <div class="welcome-message">
                <h3>Welcome to Bubbas.ai!</h3>
                <p>Start chatting with your AI companion below.</p>
            </div>
            {% endfor %}
        </div>
        
        <div class="chat-input">
            <form id="message-form">
                <textarea id="message-input" class="message-input" placeholder="Type your message here..." rows="3"></textarea>
                <div class="actions">
                    <button type="submit" class="btn btn-primary">Send</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const messagesContainer = document.getElementById('chat-messages');
        const newConversationBtn = document.getElementById('new-conversation-btn');
        const conversationList = document.querySelector('.conversation-list');
        
        let currentConversationId = "{{ current_conversation.id }}";
        
        // Scroll to bottom of messages
        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Add message to chat
        function addMessage(content, role) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.innerHTML = content.replace(/\n/g, '<br>');
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }
        
        // Handle sending message
        messageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const messageContent = messageInput.value.trim();
            if (!messageContent) return;
            
            // Add user message to chat
            addMessage(messageContent, 'user');
            
            // Clear input
            messageInput.value = '';
            
            // Send message to server
            fetch('{% url "chatbot:send_message" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    message: messageContent,
                    conversation_id: currentConversationId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Add AI response to chat
                    addMessage(data.message.content, 'assistant');
                    
                    // Update conversation ID if this is a new conversation
                    if (data.conversation_id !== currentConversationId) {
                        currentConversationId = data.conversation_id;
                        // Add to conversation list if new
                        if (!document.querySelector(`.conversation-item[data-id="${currentConversationId}"]`)) {
                            location.reload(); // Simple approach - reload to update conversation list
                        }
                    }
                } else {
                    console.error('Error:', data.message);
                    addMessage('Sorry, there was an error processing your message.', 'system');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                addMessage('Sorry, there was an error sending your message.', 'system');
            });
        });
        
        // Handle creating new conversation
        newConversationBtn.addEventListener('click', function() {
            fetch('{% url "chatbot:create_conversation" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Redirect to new conversation
                    window.location.href = `{% url "chatbot:chat" %}?conversation_id=${data.conversation.id}`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
        
        // Handle clicking on conversation in list
        conversationList.addEventListener('click', function(e) {
            if (e.target.classList.contains('conversation-item')) {
                const conversationId = e.target.dataset.id;
                window.location.href = `{% url "chatbot:chat" %}?conversation_id=${conversationId}`;
            }
        });
        
        // Initial scroll to bottom
        scrollToBottom();
    });
</script>
{% endblock %}